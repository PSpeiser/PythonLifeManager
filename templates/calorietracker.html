<!DOCTYPE html>
<html>
<head>
    <script src="/static/jquery-1.10.2.js"></script>
    <script>
        $.ajaxSetup({
            cache: true
        });
    </script>
    <script src="/static/jquery.dataTables.js"></script>
    <script src="/static/jquery.jstree.js"></script>
    <script src="/static/ui/jquery-ui.js"></script>
    <script src="/static/d3.v3.js"></script>
    <link rel="stylesheet" href="/static/themes/base/jquery-ui.css">
    <style>
        body {
            font: 12px sans-serif;
            background-color: #eaeaea;
        }

        #tree {
            width: 300px;
            float: left;
            border: 1px ridge darkgray;
            margin: 2px;
            padding: 5px;
            background-color: #eeeeee;
        }

        .red {
            background-color: #A60C00;
            stroke: #A60C00;
        }

        .yellow {
            background-color: #FFD300;
            stroke: #FFD300;
        }

        .green {
            background-color: #1DD300;
            stroke: #1DD300;
        }

        #wrapper {
            overflow: hidden;
        }

            /*calorie_graph*/
        #calorie_graph, #svg_placeholder {
            float: left;
            border: 1px ridge darkgray;
            margin: 2px;
        }

        #background_rect {
            fill: #eeeeee;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .axis path,
        .axis line,
        .domain {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
            stroke-width: 1px;
        }

        path {
            stroke: steelblue;
            stroke-width: 2;
            stroke-width: 1.5px;
            fill: none;
        }

        .threshold_line {
            stroke-width: 1.5px;
            stroke-opacity: 1;
        }

        path.data {
            fill: transparent;
            stroke: grey;
            stroke-width: 2;
        }

            /*foodtable*/
        #table_wrapper {
            float: left;
            max-width: 178px;
            overflow: auto;
            margin: 2px;
            border: 1px ridge darkgray;
            padding: 5px;

        }

        #table_processing {
            height: 0px;
            padding: 0px;
            margin: 0px;
        }

    </style>
    <script>
        function refreshElements() {
            $("#tree").jstree("refresh");
            $("#calorie_graph").trigger("reload");
            oTable.fnReloadAjax();
        }
        ;
    </script>
</head>
<body>

<div id="wrapper">
    <div id="tree"></div>
    <script>
        $.getScript('meal_tree.js');
    </script>
    <div id="calorie_graph_wrapper"></div>
    <script>
        $.getScript('calorie_graph.js');
    </script>
    <table id="table" cellpadding="1" cellspacing="1" border="1">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>KCal</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div id="weight_graph_wrapper"></div>
    <script>
        $.getScript("weight_graph.js")
    </script>
</div>


<script>

    /*
     .########.....###....########....###....########....###....########..##.......########..######.
     .##.....##...##.##......##......##.##......##......##.##...##.....##.##.......##.......##....##
     .##.....##..##...##.....##.....##...##.....##.....##...##..##.....##.##.......##.......##......
     .##.....##.##.....##....##....##.....##....##....##.....##.########..##.......######....######.
     .##.....##.#########....##....#########....##....#########.##.....##.##.......##.............##
     .##.....##.##.....##....##....##.....##....##....##.....##.##.....##.##.......##.......##....##
     .########..##.....##....##....##.....##....##....##.....##.########..########.########..######.
     */
    $(document).ready(function () {
        oTable = $('#table').dataTable({
            bProcessing: true,
            sAjaxSource: 'food.json',
            "aoColumns": [
                /* ID */   { "bSearchable": false, "bVisible": false },
                /* Name */  null,
                /* KCal */ null
            ],
            bSort: false,
            "bFilter": false,
            "bInfo": false,
            bAutoWidth: false,
            sScrollX: 'auto',
            sScrollY: "300px",
            bScrollCollapse: true,
            bPaginate: false,
            fnDrawCallback: function () {
                clickRowHandler();
            }});
    });
    function clickRowHandler() {
        $('#table tbody tr').bind('dblclick', function () {
                    var aData = oTable.fnGetData(this);
                    var food_id = aData[0];
                    //add meal here
                    $.post("add_meal", {
                        food_id: food_id,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    }, function (data) {
                        refreshElements();
                    })

                }
        );
    }
    $.fn.dataTableExt.oApi.fnReloadAjax = function (oSettings, sNewSource, fnCallback, bStandingRedraw) {
        if (sNewSource !== undefined && sNewSource !== null) {
            oSettings.sAjaxSource = sNewSource;
        }

        // Server-side processing should just call fnDraw
        if (oSettings.oFeatures.bServerSide) {
            this.fnDraw();
            return;
        }

        this.oApi._fnProcessingDisplay(oSettings, true);
        var that = this;
        var iStart = oSettings._iDisplayStart;
        var aData = [];

        this.oApi._fnServerParams(oSettings, aData);

        oSettings.fnServerData.call(oSettings.oInstance, oSettings.sAjaxSource, aData, function (json) {
            /* Clear the old information from the table */
            that.oApi._fnClearTable(oSettings);

            /* Got the data - add it to the table */
            var aData = (oSettings.sAjaxDataProp !== "") ?
                    that.oApi._fnGetObjectDataFn(oSettings.sAjaxDataProp)(json) : json;

            for (var i = 0; i < aData.length; i++) {
                that.oApi._fnAddData(oSettings, aData[i]);
            }

            oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();

            that.fnDraw();

            if (bStandingRedraw === true) {
                oSettings._iDisplayStart = iStart;
                that.oApi._fnCalculateEnd(oSettings);
                that.fnDraw(false);
            }

            that.oApi._fnProcessingDisplay(oSettings, false);

            /* Callback user function - for event handlers etc */
            if (typeof fnCallback == 'function' && fnCallback !== null) {
                fnCallback(oSettings);
            }
        }, oSettings);
    };
</script>
</body>
</html>